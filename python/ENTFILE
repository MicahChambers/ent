#!/usr/bin/ent

SINGLE=-1
OPT=LBFGS
ITERS=10000
GSTOP=0.01
FSTOP=0.00001
ALPHA=0.01
ALPHA_JAC=0
SMOOTH=1.7 0.8 .3
RESCALE=2
HIST=16
DIST=15
BINS=250
KERN=6

NPLDIR=/ifs/students/mchambers/npl-latest/bin/
BFIT=/ifs/students/mchambers/brainsfit/BRAINSFit 

BASE=/ifs/faculty/shattuck/micahc/thousand_connectomes
SUBJECT=sub04097 sub08723 sub14692 sub18955 sub24781 sub29425 sub35020  \
		sub41170 sub47141 sub51586 sub56108 sub60809 sub66131 sub53282
FMRIB=${BASE}/${SUBJECT}/func/rest
T1B=${BASE}/${SUBJECT}/anat/mprage_anonymized

${FMRIB}_bcl.nii.gz: ${FMRIB}.nii.gz
	${NPLDIR}/imgSimpleSegment -m pthresh -i $< -o $>

${FMRIB}_bc.nii.gz: ${FMRIB}.nii.gz ${FMRIB}_bcl.nii.gz
	${NPLDIR}/imgSimpleBiasCorrect -i ${<0} -L ${<1}.nii.gz -o $>
	
${T1B}_bcl.nii.gz: ${T1B}.nii.gz
	${NPLDIR}/imgSimpleSegment -m pthresh -i $< -o $>

${T1B}_bc.nii.gz: ${T1B}.nii.gz ${T1B}_bcl.nii.gz
	${NPLDIR}/imgSimpleBiasCorrect -i ${<0} -L ${<1}.nii.gz -o $>
	
${T1B}_fsp.nii.gz ${T1B}_fsp.tfm: ${T1B}_bc.nii.gz ${FMRIB}_bc.nii.gz 
	${BFIT} --initializeTransformMode useMomentsAlign --useRigid \
	--movingVolume ${<0} --fixedVolume ${<1} --outputVolume ${>0} \
	--linearTransform ${>1}


${FMRIB}_dc.nii.gz ${FMRIB}_field.nii.gz ${FMRIB}_mc.nii.gz ${FMRIB}_motion.txt: \
				${FMRIB}_bc.nii.gz ${T1B}_fsp.nii.gz 
	${NPLDIR}/fIDistortionCorrect -i ${<0} -s ${<1} -o ${>0} -f ${>1} ${SINGLE} \
				-D 3 -d ${DIST} --mc-only ${<2} --motion ${< 3} -a ${ALPHA} \
				-j ${ALPHA_JAC} --bd-iters ${ITERS} --bd-lbfgs-hist ${HIST} \
	 			--opttype ${OPT} ${-S *SMOOTH} --bd-bins ${BINS} --bd-kern-rad ${KERN} \
	 			--bd-gstop ${GSTOP} --bd-fstop ${FSTOP}
